// Control Node - Tests toggle/action controls at various zoom levels
//
// Controls tested:
// - CheckBox (small click targets)
// - Switch (toggle control)
// - Button (various sizes)
// - Slider (draggable range control)
//
// LOD Levels:
// - Full (zoom > 0.5): All widgets visible and interactive
// - Simplified (0.25 < zoom <= 0.5): Title + pins only
// - Minimal (zoom <= 0.25): Colored rectangle with title

import { CheckBox, Switch, Button, Slider } from "std-widgets.slint";
import { Pin, PinTypes, BaseNode } from "@slint-node-editor/node-editor.slint";

// Control node data passed from Rust
export struct ControlNodeData {
    id: int,
    title: string,
    world-x: float,
    world-y: float,
    check-a: bool,
    check-b: bool,
    switch-value: bool,
    slider-value: float,
}

export component ControlNode inherits BaseNode {
    in property <string> title: "Control";

    // Pin IDs
    in property <int> input-pin-id: self.node-id * 10;
    in property <int> output-pin-id: self.node-id * 10 + 1;

    // Node state
    in-out property <bool> check-a: false;
    in-out property <bool> check-b: true;
    in-out property <bool> switch-value: true;
    in-out property <float> slider-value: 0.5;

    // Callbacks for widget changes
    callback check-a-toggled(int, bool);     // node-id, new-value
    callback check-b-toggled(int, bool);     // node-id, new-value
    callback switch-toggled(int, bool);      // node-id, new-value
    callback slider-changed(int, float);     // node-id, new-value
    callback action-clicked(int, string);    // node-id, action-name

    // === LOD Configuration (can be overridden by parent) ===
    in property <float> lod-full-threshold: 0.5;
    in property <float> lod-simplified-threshold: 0.25;
    in property <length> min-node-width: 80px;
    in property <length> min-node-height: 40px;

    // LOD level: 2=full, 1=simplified, 0=minimal
    property <int> lod-level: self.zoom > lod-full-threshold ? 2
                            : self.zoom > lod-simplified-threshold ? 1
                            : 0;

    // === Layout constants ===
    property <length> content-padding: 8px;
    property <length> title-height: 28px;
    property <length> row-height: 32px;
    property <length> row-spacing: 4px;
    property <length> pin-area-width: 20px;

    // Pin dimensions
    property <length> base-pin-size: 12px;
    property <length> pin-size: max(base-pin-size * self.zoom, 8px);  // Minimum 8px for clickability

    // === Size calculations per LOD ===
    // Full size
    property <length> full-width: 260px;
    property <length> full-height: content-padding + title-height + content-padding
                                   + (row-height * 4) + (row-spacing * 3) + content-padding;

    // Simplified size
    property <length> simplified-width: 100px;
    property <length> simplified-height: content-padding + title-height + content-padding;

    // Minimal size (from configurable properties)
    property <length> minimal-width: root.min-node-width;
    property <length> minimal-height: root.min-node-height;

    // Effective dimensions based on LOD
    property <length> effective-base-width: lod-level == 2 ? full-width
                                          : lod-level == 1 ? simplified-width
                                          : minimal-width;
    property <length> effective-base-height: lod-level == 2 ? full-height
                                           : lod-level == 1 ? simplified-height
                                           : minimal-height;

    // Apply zoom with minimum size floor
    width: max(effective-base-width * self.zoom, minimal-width);
    height: max(effective-base-height * self.zoom, minimal-height);

    // Node colors
    property <color> node-color: #5d3d3d;
    property <color> node-color-selected: #7a4a4a;

    // === LOD 2: Full content ===
    if lod-level == 2: Rectangle {
        width: 100%;
        height: 100%;
        background: root.selected ? root.node-color-selected : root.node-color;
        border-radius: 4px * root.zoom;
        border-width: root.selected ? 2px : 1px;
        border-color: root.selected ? #f88 : #555;

        VerticalLayout {
            padding: root.content-padding * root.zoom;
            spacing: root.row-spacing * root.zoom;

            // Title bar
            Rectangle {
                height: root.title-height * root.zoom;
                background: root.selected ? root.node-color-selected.darker(0.2) : root.node-color.darker(0.2);
                border-radius: 4px * root.zoom;

                Text {
                    text: root.title;
                    color: white;
                    font-size: 14px * root.zoom;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Row 1: Checkboxes
            HorizontalLayout {
                height: root.row-height * root.zoom;
                spacing: 16px * root.zoom;
                padding-left: root.pin-area-width * root.zoom;
                padding-right: root.pin-area-width * root.zoom;
                alignment: start;

                CheckBox {
                    text: "Option A";
                    checked <=> root.check-a;
                    toggled => {
                        root.check-a-toggled(root.node-id, root.check-a);
                    }
                }

                CheckBox {
                    text: "Option B";
                    checked <=> root.check-b;
                    toggled => {
                        root.check-b-toggled(root.node-id, root.check-b);
                    }
                }
            }

            // Row 2: Switch
            HorizontalLayout {
                height: root.row-height * root.zoom;
                spacing: 12px * root.zoom;
                padding-left: root.pin-area-width * root.zoom;
                padding-right: root.pin-area-width * root.zoom;
                alignment: start;

                Text {
                    text: "Enable:";
                    color: #ccc;
                    font-size: 12px * root.zoom;
                    vertical-alignment: center;
                }

                Switch {
                    checked <=> root.switch-value;
                    toggled => {
                        root.switch-toggled(root.node-id, root.switch-value);
                    }
                }

                Text {
                    text: root.switch-value ? "ON" : "OFF";
                    color: root.switch-value ? #8f8 : #f88;
                    font-size: 11px * root.zoom;
                    vertical-alignment: center;
                }
            }

            // Row 3: Slider
            HorizontalLayout {
                height: root.row-height * root.zoom;
                spacing: 8px * root.zoom;
                padding-left: root.pin-area-width * root.zoom;
                padding-right: root.pin-area-width * root.zoom;

                Text {
                    text: "Level:";
                    color: #ccc;
                    font-size: 12px * root.zoom;
                    vertical-alignment: center;
                    width: 40px * root.zoom;
                }

                Slider {
                    horizontal-stretch: 1;
                    value <=> root.slider-value;
                    minimum: 0;
                    maximum: 1;
                    changed(val) => {
                        root.slider-changed(root.node-id, val);
                    }
                }

                Text {
                    text: round(root.slider-value * 100) + "%";
                    color: #aaa;
                    font-size: 10px * root.zoom;
                    vertical-alignment: center;
                    width: 35px * root.zoom;
                    horizontal-alignment: right;
                }
            }

            // Row 4: Buttons
            HorizontalLayout {
                height: root.row-height * root.zoom;
                spacing: 8px * root.zoom;
                padding-left: root.pin-area-width * root.zoom;
                padding-right: root.pin-area-width * root.zoom;
                alignment: center;

                Button {
                    text: "Apply";
                    clicked => {
                        root.action-clicked(root.node-id, "apply");
                    }
                }

                Button {
                    text: "Reset";
                    clicked => {
                        root.action-clicked(root.node-id, "reset");
                    }
                }

                Button {
                    text: "...";
                    clicked => {
                        root.action-clicked(root.node-id, "more");
                    }
                }
            }
        }
    }

    // === LOD 1: Simplified content (title + pins only) ===
    if lod-level == 1: Rectangle {
        width: 100%;
        height: 100%;
        background: root.selected ? root.node-color-selected : root.node-color;
        border-radius: 4px * root.zoom;
        border-width: root.selected ? 2px : 1px;
        border-color: root.selected ? #f88 : #555;

        VerticalLayout {
            padding: root.content-padding * root.zoom;

            Rectangle {
                height: root.title-height * root.zoom;
                background: root.selected ? root.node-color-selected.darker(0.2) : root.node-color.darker(0.2);
                border-radius: 4px * root.zoom;

                Text {
                    text: root.title;
                    color: white;
                    font-size: max(14px * root.zoom, 9px);
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
    }

    // === LOD 0: Minimal content (colored box with title) ===
    if lod-level == 0: Rectangle {
        width: 100%;
        height: 100%;
        background: root.selected ? root.node-color-selected : root.node-color;
        border-radius: 4px;
        border-width: root.selected ? 2px : 1px;
        border-color: root.selected ? #f88 : #555;

        Text {
            text: root.title;
            color: white;
            font-size: 9px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    // === Input pin (left side) ===
    input-pin := Pin {
        x: root.content-padding * root.zoom;
        y: parent.height / 2 - root.pin-size / 2;
        pin-id: root.input-pin-id;
        node-id: root.node-id;
        pin-type: PinTypes.input;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        base-color: #2196F3;
        hover-color: #42A5F5;
        base-size: root.base-pin-size;
        visible: root.lod-level > 0;
        drag-started(id, x, y) => { root.pin-drag-started(id, x, y); }
        drag-moved(id, x, y) => { root.pin-drag-moved(id, x, y); }
        drag-ended(id, x, y) => { root.pin-drag-ended(id, x, y); }
        report-position(pin-id, node-id, pin-type, x, y) => {
            root.pin-position-changed(pin-id, node-id, pin-type, x, y);
        }
    }

    // === Output pin (right side) ===
    output-pin := Pin {
        x: parent.width - root.content-padding * root.zoom - root.pin-size;
        y: parent.height / 2 - root.pin-size / 2;
        pin-id: root.output-pin-id;
        node-id: root.node-id;
        pin-type: PinTypes.output;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        base-color: #FF9800;
        hover-color: #FFB74D;
        base-size: root.base-pin-size;
        visible: root.lod-level > 0;
        drag-started(id, x, y) => { root.pin-drag-started(id, x, y); }
        drag-moved(id, x, y) => { root.pin-drag-moved(id, x, y); }
        drag-ended(id, x, y) => { root.pin-drag-ended(id, x, y); }
        report-position(pin-id, node-id, pin-type, x, y) => {
            root.pin-position-changed(pin-id, node-id, pin-type, x, y);
        }
    }

    init => {
        if (self.node-id > 0) {
            root.pin-position-changed(root.input-pin-id, self.node-id, PinTypes.input,
                                      input-pin.center-x, input-pin.center-y);
            root.pin-position-changed(root.output-pin-id, self.node-id, PinTypes.output,
                                      output-pin.center-x, output-pin.center-y);
        }
    }
}
