import { NodeEditor, BaseNode, Pin, PinTypes, LinkData } from "@slint-node-editor/node-editor.slint";
import { Button } from "std-widgets.slint";

export struct NodeData {
    id: int,
    title: string,
    x: float,
    y: float,
}

export { LinkData }

component SimpleNode inherits BaseNode {
    in property <string> title: "Node";
    width: 120px * self.zoom;
    height: 60px * self.zoom;

    Rectangle {
        background: root.selected ? #4a6a9a : #333;
        border-radius: 4px * root.zoom;
        border-width: 1px * root.zoom;
        border-color: #666;

        Text {
            text: root.title;
            color: white;
            font-size: 12px * root.zoom;
        }
    }

    // Input pin
    Pin {
        x: 0px;
        y: parent.height / 2 - self.height / 2;
        pin-id: root.node-id * 2;
        node-id: root.node-id;
        pin-type: PinTypes.input;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        report-position(id, nid, type, x, y) => {
            root.report-position(id, nid, type, x, y);
        }
    }

    // Output pin
    Pin {
        x: parent.width - self.width;
        y: parent.height / 2 - self.height / 2;
        pin-id: root.node-id * 2 + 1;
        node-id: root.node-id;
        pin-type: PinTypes.output;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        report-position(id, nid, type, x, y) => {
            root.report-position(id, nid, type, x, y);
        }
    }

    callback report-position(int, int, int, length, length);
}

export component MainWindow inherits Window {
    title: "Sugiyama Layout Example";
    width: 1000px;
    height: 700px;

    in property <[NodeData]> nodes;
    in property <[LinkData]> links <=> editor.links;
    in-out property <string> grid_commands <=> editor.grid-commands;
    in-out property <int> dragged-node-id: 0;

    out property <float> width_: self.width / 1px;
    out property <float> height_: self.height / 1px;

    callback node-rect-changed <=> editor.node-rect-changed;
    callback pin-position-changed <=> editor.pin-position-changed;
    callback request-grid-update <=> editor.request-grid-update;
    callback update-viewport(float, float, float);
    callback node-drag-started <=> editor.node-drag-started;
    callback node-drag-ended <=> editor.node-drag-ended;
    pure callback compute-link-path <=> editor.compute-link-path;
    callback layout-requested();
    callback scramble-requested();

    VerticalLayout {
        HorizontalLayout {
            padding: 8px;
            height: 40px;
            spacing: 8px;

            Button {
                text: "Auto Layout";
                clicked => {
                    root.layout-requested();
                }
            }
            Button {
                text: "Scramble";
                clicked => {
                    root.scramble-requested();
                }
            }
        }

        editor := NodeEditor {
            viewport-changed => {
                root.update-viewport(self.zoom, self.pan-x / 1px, self.pan-y / 1px);
            }

            for data in root.nodes: SimpleNode {
                node-id: data.id;
                title: data.title;
                world-x: data.x * 1px;
                world-y: data.y * 1px;
                zoom: editor.zoom;
                pan-x: editor.pan-x;
                pan-y: editor.pan-y;
                drag-offset-x: data.id == root.dragged-node-id ? editor.drag-offset-x : 0px;
                drag-offset-y: data.id == root.dragged-node-id ? editor.drag-offset-y : 0px;

                report-rect(id, x, y, w, h) => {
                    editor.report-node-rect(id, x, y, w, h);
                }
                report-position(pid, nid, pt, x, y) => {
                    editor.report-pin-position(pid, nid, pt, x, y);
                }
                drag-started(id, already-selected, wx, wy) => {
                    root.dragged-node-id = id;
                    editor.start-node-drag(id, already-selected, wx, wy);
                }
                drag-moved(id, dx, dy) => {
                    editor.update-node-drag(dx, dy);
                }
                drag-ended(id, dx, dy) => {
                    root.dragged-node-id = 0;
                    editor.end-node-drag(dx, dy);
                }
            }
        }
    }
}
