// Test UI for integration testing
// Extends minimal example with all callbacks exposed for testing

import { NodeEditor, BaseNode, Pin, PinTypes, LinkData } from "@slint-node-editor/node-editor.slint";

export struct NodeData {
    id: int,
    title: string,
    x: float,
    y: float,
}

// Re-export LinkData for Rust
export { LinkData }

component SimpleNode inherits BaseNode {
    in property <string> title: "Node";
    width: 150px * self.zoom;
    height: 100px * self.zoom;

    Rectangle {
        background: root.selected ? #4a6a9a : #333;
        border-radius: 4px * root.zoom;
        border-width: 1px * root.zoom;
        border-color: #666;

        Text {
            text: root.title;
            color: white;
            font-size: 14px * root.zoom;
        }
    }

    // Single input pin
    Pin {
        x: 0px;
        y: parent.height / 2 - self.height / 2;
        pin-id: root.node-id * 2;
        node-id: root.node-id;
        pin-type: PinTypes.input;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        report-position(id, nid, type, x, y) => {
            root.report-position(id, nid, type, x, y);
        }
    }

    // Single output pin
    Pin {
        x: parent.width - self.width;
        y: parent.height / 2 - self.height / 2;
        pin-id: root.node-id * 2 + 1;
        node-id: root.node-id;
        pin-type: PinTypes.output;
        zoom: root.zoom;
        node-screen-x: root.screen-x;
        node-screen-y: root.screen-y;
        report-position(id, nid, type, x, y) => {
            root.report-position(id, nid, type, x, y);
        }
    }

    callback report-position(int, int, int, length, length);
}

export component MainWindow inherits Window {
    title: "Test Node Editor";
    width: 800px;
    height: 600px;

    in property <[NodeData]> nodes;
    in property <[LinkData]> links <=> editor.links;
    in-out property <string> grid_commands <=> editor.grid-commands;
    in-out property <int> dragged-node-id: 0;

    // Size for grid generation
    out property <float> width_: self.width / 1px;
    out property <float> height_: self.height / 1px;

    // Selection state (exposed for tests)
    in-out property <[int]> selected-node-ids <=> editor.selected-node-ids;
    in-out property <[int]> selected-link-ids <=> editor.selected-link-ids;
    in-out property <int> selection-version <=> editor.selection-version;

    // Core callbacks to Rust
    callback node-rect-changed <=> editor.node-rect-changed;
    callback pin-position-changed <=> editor.pin-position-changed;
    callback request-grid-update <=> editor.request-grid-update;
    callback update-viewport(/* zoom */ float, /* pan-x */ float, /* pan-y */ float);
    callback node-drag-started <=> editor.node-drag-started;
    callback node-drag-ended <=> editor.node-drag-ended;
    pure callback compute-link-path <=> editor.compute-link-path;

    // Additional callbacks for testing
    callback link-requested <=> editor.link-requested;
    callback link-cancelled <=> editor.link-cancelled;
    callback selection-changed <=> editor.selection-changed;
    callback delete-selected <=> editor.delete-selected;
    callback context-menu-requested <=> editor.context-menu-requested;
    callback add-node-requested <=> editor.add-node-requested;

    // Selection callbacks
    callback select-node <=> editor.select-node;
    callback select-link <=> editor.select-link;
    callback clear-selection <=> editor.clear-selection;
    callback sync-selection-to-nodes <=> editor.sync-selection-to-nodes;
    callback sync-selection-to-links <=> editor.sync-selection-to-links;
    pure callback is-selected <=> editor.is-selected;
    pure callback is-link-selected <=> editor.is-link-selected;

    // Compute callbacks
    callback compute-pin-at <=> editor.compute-pin-at;
    callback compute-link-at <=> editor.compute-link-at;
    callback compute-box-selection <=> editor.compute-box-selection;
    callback compute-link-box-selection <=> editor.compute-link-box-selection;
    callback compute-link-preview-path <=> editor.compute-link-preview-path;

    // Function to refresh links after geometry is reported
    public function refresh-links() {
        editor.refresh-links();
    }

    editor := NodeEditor {
        width: 100%;
        height: 100%;

        viewport-changed => {
            root.update-viewport(self.zoom, self.pan-x / 1px, self.pan-y / 1px);
        }

        for data in root.nodes: SimpleNode {
            node-id: data.id;
            title: data.title;
            world-x: data.x * 1px;
            world-y: data.y * 1px;
            zoom: editor.zoom;
            pan-x: editor.pan-x;
            pan-y: editor.pan-y;
            drag-offset-x: data.id == root.dragged-node-id ? editor.drag-offset-x : 0px;
            drag-offset-y: data.id == root.dragged-node-id ? editor.drag-offset-y : 0px;

            report-rect(id, x, y, w, h) => {
                editor.report-node-rect(id, x, y, w, h);
            }
            report-position(pid, nid, pt, x, y) => {
                editor.report-pin-position(pid, nid, pt, x, y);
            }
            drag-started(id, already-selected, wx, wy) => {
                root.dragged-node-id = id;
                editor.start-node-drag(id, already-selected, wx, wy);
            }
            drag-moved(id, dx, dy) => {
                editor.update-node-drag(dx, dy);
            }
            drag-ended(id, dx, dy) => {
                root.dragged-node-id = 0;
                editor.end-node-drag(dx, dy);
            }
        }
    }
}
